<div class="container-proveedores">
  <h2>Turnos Agendados</h2>

  <!-- Selector de fecha -->
  <div class="search-container mb-3">
    <input type="date" [(ngModel)]="fechaSeleccionada" />
  </div>

  <!-- Tabla de turnos -->
  <div class="table-responsive">
    <table class="styled-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Hora Inicio</th>
          <th>Hora Fin</th>
          <th>Proveedor</th>
          <th>Estado</th>
          <th>Jaula</th>
          <th>Hora Inicio Recepción</th>
          <th>Hora Fin Recepción</th>
          <th>Productos</th>
          <th>Acciones</th>
          <th>Detalles</th>
        </tr>
      </thead>
      <tbody>
        @for (t of turnosFiltrados; track t.idTurno) {
        <tr>
          <td>{{ t.idTurno }}</td>
          <td>{{ t.horaInicioAgendamiento }}</td>
          <td>{{ t.horaFinAgendamiento }}</td>
          <td>{{ getNombreProveedor(t.idProveedor) }}</td>
          <td>
            <span
              class="badge"
              [ngClass]="{
                'bg-warning': t.estado === 'pendiente',
                'bg-info': t.estado === 'en recepcion',
                'bg-success': t.estado === 'completado'
              }"
            >
              {{ t.estado }}
            </span>
          </td>
          <td>{{ getNombreJaula(t) }}</td>
          <td>{{ t.horaInicioRecepcion || "-" }}</td>
          <td>{{ t.horaFinRecepcion || "-" }}</td>
          <td>
            <ul>
              @for (p of t.detalles_res; track p.idProducto) {
              <li>{{ p.nombre }} ({{ p.cantidad }})</li>
              }
            </ul>
          </td>
          <td>
            @if (t.estado === 'pendiente') {
            <button class="btn-save btn-sm" (click)="iniciarRecepcion(t)">
              Iniciar Recepción
            </button>
            } @if (t.estado === 'en recepcion') {
            <button class="btn-edit btn-sm" (click)="finalizarRecepcion(t)">
              Finalizar Recepción
            </button>
            } @if (t.estado === 'completado') {
            <span class="text-success">✓ Completado</span>
            }
          </td>
          <td>
            <button class="btn-info btn-sm" (click)="verDetalles(t)">
              Ver Detalles
            </button>
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- Card selección de jaula -->
  @if (turnoSeleccionado) {
  <div class="card add-card">
    <h5>Seleccione jaula para turno {{ turnoSeleccionado.idTurno }}</h5>
    <select [(ngModel)]="jaulaElegidaId">
      @for (j of jaulasDisponibles; track j.idJaula) {
      <option [value]="j.idJaula">{{ j.nombre }}</option>
      }
    </select>
    <button
      (click)="confirmarInicioRecepcion()"
      [disabled]="!jaulaElegidaId"
      class="btn-save"
    >
      Confirmar Inicio
    </button>
  </div>
  }

  <!-- Modal de detalles -->
  @if (mostrarPopupDetalles) {
  <div class="modal-overlay" (click)="cerrarPopupDetalles()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Productos</h3>
        <button
          type="button"
          class="btn-close-white"
          (click)="cerrarPopupDetalles()"
        >
          ×
        </button>
      </div>
      <div class="modal-body">
        @if (turnoDetalles) {
        <h4 class="mb-3">
          Turno {{ turnoDetalles.idTurno }} -
          {{ getNombreProveedor(turnoDetalles.idProveedor) }}
        </h4>
        <div class="table-responsive">
          <table class="styled-table">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Cantidad</th>
              </tr>
            </thead>
            <tbody>
              @for (detalle of turnoDetalles.detalles_res; track
              detalle.idProducto) {
              <tr>
                <td>
                  {{ detalle.nombre || getNombreProducto(detalle.idProducto) }}
                </td>
                <td>{{ detalle.cantidad }}</td>
              </tr>
              }
            </tbody>
          </table>
        </div>
        @if (!turnoDetalles.detalles_res || turnoDetalles.detalles_res.length
        === 0) {
        <div class="text-center text-muted">
          No hay productos registrados para este turno
        </div>
        } }
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn-cancel"
          (click)="cerrarPopupDetalles()"
        >
          Cerrar
        </button>
      </div>
    </div>
  </div>
  }
</div>
